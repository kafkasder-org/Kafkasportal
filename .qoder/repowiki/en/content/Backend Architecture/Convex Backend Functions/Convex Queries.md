# Convex Queries

<cite>
**Referenced Files in This Document**   
- [auth.ts](file://convex/auth.ts)
- [users.ts](file://convex/users.ts)
- [schema.ts](file://convex/schema.ts)
- [api.ts](file://src/lib/convex/api.ts)
- [client.ts](file://src/lib/convex/client.ts)
- [useApiCache.ts](file://src/hooks/useApiCache.ts)
- [cache-config.ts](file://src/lib/cache-config.ts)
</cite>

## Table of Contents

1. [Introduction](#introduction)
2. [Query Definition and Registration](#query-definition-and-registration)
3. [Query Execution and Data Retrieval](#query-execution-and-data-retrieval)
4. [Client-Side Query Access](#client-side-query-access)
5. [Performance Considerations](#performance-considerations)
6. [Real-Time Subscription Mechanics](#real-time-subscription-mechanics)
7. [Conclusion](#conclusion)

## Introduction

Convex queries in Kafkasder-panel are read-only functions designed to retrieve data from the Convex database. These queries execute within a consistent snapshot of the database, ensuring data integrity and consistency across concurrent operations. The system automatically synchronizes query results in real time to subscribed clients, enabling reactive user interfaces that update seamlessly when underlying data changes. This documentation details the implementation, usage, and optimization of Convex queries within the application architecture.

## Query Definition and Registration

Convex queries are defined using the `query` function imported from `./_generated/server` and registered within individual module files in the `convex/` directory. Each query is exported as a named function, making it accessible through the generated Convex API. The query definition includes two primary components: argument validation and a handler function.

In the `auth.ts` module, the `getUserByEmail` query demonstrates this pattern by accepting an email parameter and returning the corresponding user document. The arguments are validated using Convex's value system (`v.string()`), ensuring type safety at runtime. Similarly, the `users.ts` module contains multiple queries such as `list`, `get`, and `getByEmail`, each with specific parameter requirements and validation rules.

The data model referenced by these queries is defined in `schema.ts`, which specifies the structure of all collections and their indexes. For example, the `users` collection includes indexes on `email`, `role`, and `isActive` fields, enabling efficient query execution when filtering by these attributes. The schema also defines search indexes, such as `by_search` on the `name` field, which supports full-text search capabilities.

**Section sources**

- [auth.ts](file://convex/auth.ts#L34-L49)
- [users.ts](file://convex/users.ts#L6-L82)
- [schema.ts](file://convex/schema.ts#L9-L37)

## Query Execution and Data Retrieval

Query execution occurs within a consistent snapshot of the Convex database, providing isolation from concurrent modifications. When a query is invoked, it receives a `QueryCtx` object as its first parameter, which provides access to the database reader interface (`ctx.db`). This interface allows the query to retrieve documents by ID or execute collection queries using index-based lookups.

The `getUserByEmail` query in `auth.ts` demonstrates index-based retrieval by using `withIndex("by_email", (q) => q.eq("email", args.email))` to efficiently locate a user document. This approach leverages the database index defined in `schema.ts`, resulting in O(log n) lookup performance rather than a full collection scan. Similarly, the `list` query in `users.ts` implements pagination and filtering logic, supporting parameters for search, role filtering, and active status.

Parameter validation is implemented using Convex's value system, which provides runtime type checking and serialization. For complex queries with multiple optional parameters, the handler function contains conditional logic to construct the appropriate database query. The `list` query in `users.ts` demonstrates this by branching based on the presence of search, role, or active status filters, then applying additional in-memory filtering when necessary.

**Section sources**

- [auth.ts](file://convex/auth.ts#L34-L49)
- [users.ts](file://convex/users.ts#L6-L63)
- [schema.ts](file://convex/schema.ts#L9-L37)

## Client-Side Query Access

Client-side components access Convex queries through the generated Convex API, available as `api.queries.*` in the application code. The `api` utility is automatically generated by Convex and provides type-safe references to all registered queries. In Kafkasder-panel, this access is abstracted through helper modules like `src/lib/convex/api.ts`, which exports convenience functions for calling queries with proper error handling and authentication context.

React components use Convex hooks such as `useQuery` from `@tanstack/react-query` to subscribe to query results. The `useApiCache.ts` module provides specialized hooks like `useUsersQuery` and `useBeneficiariesQuery` that encapsulate query configuration, including cache strategies and invalidation rules. These hooks accept parameters that are passed to the underlying Convex query and return a result object containing data, loading state, and error information.

The `useQuery` hook automatically manages the subscription lifecycle, fetching data when the component mounts and updating when parameters change. It also handles caching according to the configured stale time and garbage collection policies defined in `cache-config.ts`. This caching layer reduces unnecessary network requests and improves application performance, especially for frequently accessed data like user profiles and system parameters.

**Section sources**

- [api.ts](file://src/lib/convex/api.ts#L69-L320)
- [useApiCache.ts](file://src/hooks/useApiCache.ts#L27-L133)
- [cache-config.ts](file://src/lib/cache-config.ts#L62-L206)

## Performance Considerations

Performance optimization for Convex queries in Kafkasder-panel involves several strategies, with indexing being the most critical. The `schema.ts` file defines indexes on frequently queried fields such as `email`, `role`, and `status`, enabling efficient data retrieval. Search indexes are also configured for full-text search capabilities on fields like `name` and `subject`, using the `searchIndex` method with specified search and filter fields.

Query optimization is achieved through careful selection of index usage and avoidance of expensive operations. For example, the `list` query in `users.ts` uses index-based filtering for search, role, and active status parameters, minimizing the number of documents that need to be scanned. When multiple filters are applied, the query applies the most selective filter first to reduce the working set size.

Caching behavior is configured through the `CACHE_STRATEGIES` object in `cache-config.ts`, which defines stale times, garbage collection times, and refetch policies for different data types. Frequently changing data like tasks and messages use short stale times (30 seconds), while relatively static data like parameters and settings use longer durations (up to 1 hour). The caching strategy also controls whether queries automatically refetch when the window regains focus or the network reconnects, balancing data freshness with performance.

**Section sources**

- [schema.ts](file://convex/schema.ts#L9-L41)
- [users.ts](file://convex/users.ts#L6-L63)
- [cache-config.ts](file://src/lib/cache-config.ts#L13-L206)

## Real-Time Subscription Mechanics

Real-time subscription mechanics in Kafkasder-panel are built on Convex's reactive query system, which automatically pushes updates to subscribed clients when relevant data changes. When a client subscribes to a query using `useQuery`, Convex establishes a persistent connection that monitors the query's result set. If any document affecting the query results is modified, inserted, or deleted, Convex recomputes the query and sends the updated results to all subscribed clients.

This mechanism is particularly effective for collaborative features like task management and meeting coordination, where multiple users may be viewing and updating the same data simultaneously. The `useTasksQuery` and `useMeetingsQuery` hooks in `useApiCache.ts` leverage this real-time capability, ensuring that all users see the most current information without manual refresh.

The subscription system is optimized to minimize network traffic by only sending delta updates when possible. For queries with large result sets, Convex efficiently tracks which documents have changed and transmits only the necessary updates. This approach reduces bandwidth usage and improves responsiveness, especially on mobile networks. The client-side cache, managed by React Query, stores these updates and provides immediate access to the latest data while maintaining a consistent user experience.

**Section sources**

- [useApiCache.ts](file://src/hooks/useApiCache.ts#L68-L91)
- [cache-config.ts](file://src/lib/cache-config.ts#L120-L149)

## Conclusion

Convex queries in Kafkasder-panel provide a robust foundation for data retrieval, combining read-only safety, consistent snapshots, and real-time synchronization. By leveraging properly indexed queries, type-safe parameter validation, and intelligent caching strategies, the application achieves both performance and reliability. The integration with React's component model through custom hooks enables developers to build responsive user interfaces that automatically update when data changes, creating a seamless user experience. As the application evolves, maintaining well-structured queries and appropriate indexing will continue to be essential for optimal performance.
