name: Auto Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
  check_suite:
    types: [completed]
  status: {}

jobs:
  auto-merge:
    name: Auto Merge Pull Request
    runs-on: ubuntu-latest
    # Only run for PRs targeting main branch
    if: |
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.draft == false

    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read

    steps:
      - name: Get PR information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const labels = pr.labels.map(l => l.name);
            const author = pr.user.login;
            const title = pr.title.toLowerCase();

            // Check if PR should be auto-merged
            const hasAutoMergeLabel = labels.includes('auto-merge') || labels.includes('claude');
            const isClaudePR = author === 'Vadalov' || title.includes('claude') || labels.includes('claude');
            const shouldAutoMerge = hasAutoMergeLabel || isClaudePR;

            core.setOutput('should_merge', shouldAutoMerge);
            core.setOutput('author', author);
            core.setOutput('title', pr.title);
            core.setOutput('labels', labels.join(','));

            if (shouldAutoMerge) {
              core.info(`‚úÖ Auto-merge enabled for PR by ${author}`);
            } else {
              core.info(`‚ÑπÔ∏è Auto-merge not enabled. Add 'auto-merge' or 'claude' label to enable.`);
            }

      - name: Wait for all checks to pass
        if: steps.pr-info.outputs.should_merge == 'true'
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success,skipped,neutral
          check-regexp: '^(CI Pipeline|ci|build|test|lint|typecheck|code-quality|Pull Request Checks)'

      - name: Check PR status and mergeability
        if: steps.pr-info.outputs.should_merge == 'true'
        id: merge-check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // Check if already merged
            if (pr.merged === true) {
              core.info('‚ÑπÔ∏è PR is already merged');
              core.setOutput('can_merge', 'false');
              return;
            }

            // Check if PR is open
            if (pr.state !== 'open') {
              core.setFailed(`PR is not open (state: ${pr.state})`);
              core.setOutput('can_merge', 'false');
              return;
            }

            // Check mergeability
            if (pr.mergeable === false) {
              core.warning('‚ö†Ô∏è PR is not mergeable (may have conflicts)');
              core.setOutput('can_merge', 'false');
              return;
            }

            // Check status checks
            const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const failingStatuses = statuses.statuses.filter(s => s.state === 'failure' || s.state === 'error');
            if (failingStatuses.length > 0) {
              const criticalChecks = ['CI Pipeline', 'build', 'test', 'lint', 'typecheck'];
              const failingCritical = failingStatuses.filter(s => 
                criticalChecks.some(check => s.context.includes(check))
              );
              
              if (failingCritical.length > 0) {
                core.setFailed(`Critical checks are failing: ${failingCritical.map(s => s.context).join(', ')}`);
                core.setOutput('can_merge', 'false');
                return;
              }
            }

            core.info('‚úÖ PR is ready to merge');
            core.setOutput('can_merge', 'true');

      - name: Merge PR
        if: steps.pr-info.outputs.should_merge == 'true' && steps.merge-check.outputs.can_merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              
              // Merge PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${pr.number})`,
                commit_message: 'Auto-merged by GitHub Actions\n\nü§ñ All checks passed successfully'
              });
              
              core.info('‚úÖ PR successfully merged!');
              
              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ü§ñ **Auto-merged** by GitHub Actions\n\n‚úÖ All checks passed\n‚úÖ PR merged to \`main\` branch\n\n_Merged at ${new Date().toISOString()}_`
              });
              
            } catch (error) {
              if (error.message.includes('Pull Request is not mergeable')) {
                core.warning('‚ö†Ô∏è PR is not mergeable (may have conflicts or failing checks)');
              } else if (error.message.includes('was already merged')) {
                core.info('‚ÑπÔ∏è PR was already merged');
              } else {
                core.setFailed(`Failed to merge PR: ${error.message}`);
                throw error;
              }
            }
